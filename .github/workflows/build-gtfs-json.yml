name: Build GTFS JSON

on:
  schedule:
    - cron: "15 2 * * *"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build JSON
        env:
          GTFS_URL: https://www.transportforireland.ie/transitData/Data/GTFS_Irish_Rail.zip
          OUT_DIR: out
          WINDOW_DAYS: "90"
        run: python scripts/gtfs_json_builder.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gtfs-json
          path: out/
          if-no-files-found: error

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Read version
        id: ver
        run: |
          VER=$(jq -r '.latest' out/latest.json)
          echo "version=$VER" >> "$GITHUB_OUTPUT"

      - name: Upload versioned JSON to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          set -euo pipefail
          ROOT="out/gtfs/${{ steps.ver.outputs.version }}"
          find "$ROOT" -type f -name '*.json' | while read -r f; do
            key="gtfs/${{ steps.ver.outputs.version }}/${f##*/}"
            wrangler r2 object put "${R2_BUCKET}/${key}" \
              --file "$f" \
              --cache-control "public, max-age=31536000, immutable" \
              --content-type "application/json" \
              --account-id "$CLOUDFLARE_ACCOUNT_ID"
          done

      - name: Upload pointers to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          wrangler r2 object put "${R2_BUCKET}/latest.json" \
            --file out/latest.json \
            --cache-control "public, max-age=60" \
            --content-type "application/json" \
            --account-id "$CLOUDFLARE_ACCOUNT_ID"
          wrangler r2 object put "${R2_BUCKET}/status.json" \
            --file out/status.json \
            --cache-control "public, max-age=30" \
            --content-type "application/json" \
            --account-id "$CLOUDFLARE_ACCOUNT_ID"


      - name: Upload pointers to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          wrangler r2 object put "${R2_BUCKET}/latest.json" \
            --local out/latest.json \
            --cache-control "public, max-age=60" \
            --content-type "application/json"
          wrangler r2 object put "${R2_BUCKET}/status.json" \
            --local out/status.json \
            --cache-control "public, max-age=30" \
            --content-type "application/json"

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy

      - name: Smoke test
        env:
          HOST: dartdublin-gtfs-api-endpoint.kgans.com
        run: |
          set -euo pipefail
          curl -fsS "https://${HOST}/status" | jq .
          V=$(jq -r '.latest' out/latest.json)
          curl -fsS "https://${HOST}/gtfs/${V}/stops.json" | jq '.[0]'
